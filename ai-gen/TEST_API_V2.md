# Test API V2 Endpoints

## Prerequisites

1. Start FastAPI server:
```bash
cd D:\MySkillList
.venv\Scripts\python.exe ai-gen\main.py
```

Server should run on: http://127.0.0.1:8002

---

## Test Endpoints

### 1. Health Check

```bash
curl http://localhost:8002/api/v2/health
```

**Expected Response**:
```json
{
  "status": "healthy",
  "api_version": "v2",
  "database": "connected",
  "total_definitions": 589
}
```

---

### 2. Get All Skills

```bash
curl http://localhost:8002/api/v2/skills
```

**Expected Response**:
```json
{
  "success": true,
  "skills": [
    {
      "skill_id": "uuid",
      "skill_name": "Accessibility and inclusion",
      "skill_code": "ACIN",
      "level_count": 5
    }
  ],
  "total": 146
}
```

---

### 3. Get Skill Levels

```bash
curl http://localhost:8002/api/v2/skills/30000000-0000-0000-0000-000000000078/levels
```

**Expected Response**:
```json
{
  "success": true,
  "skill_id": "30000000-0000-0000-0000-000000000078",
  "levels": [
    {
      "level": 2,
      "description": "Level description",
      "autonomy": "Autonomy text",
      "influence": "Influence text",
      "complexity": "Complexity text",
      "business_skills": "Business skills",
      "knowledge": "Knowledge"
    }
  ]
}
```

---

### 4. Get Stats

```bash
curl http://localhost:8002/api/v2/stats
```

**Expected Response**:
```json
{
  "success": true,
  "stats": {
    "total_skills": 146,
    "total_level_definitions": 589,
    "sfia_levels": "1-7"
  }
}
```

---

### 5. Generate Questions (Real AI with Gemini 2.0)

```bash
curl -X POST http://localhost:8002/api/v2/generate-questions \
  -H "Content-Type: application/json" \
  -d '{
    "question_type": ["Multiple Choice", "Short Answer"],
    "language": "English",
    "number_of_questions": 5,
    "skills": [{
      "skill_id": "30000000-0000-0000-0000-000000000078",
      "skill_name": "Accessibility and inclusion",
      "skill_code": "ACIN"
    }],
    "target_proficiency_level": [3, 4],
    "difficulty": "Medium",
    "additional_context": "Focus on WCAG 2.1 standards"
  }'
```

**Expected Response** (Real AI-generated content):
```json
{
  "questions": [
    {
      "skill_id": "30000000-0000-0000-0000-000000000078",  // ✅ Always included
      "type": "MultipleChoice",
      "content": "Which WCAG 2.1 success criterion requires that all functionality be operable through a keyboard interface?",
      "target_level": 3,
      "difficulty": "Medium",
      "points": 10,
      "time_limit_seconds": 120,
      "tags": ["WCAG", "Keyboard Accessibility"],
      "options": [
        {
          "content": "2.1.1 Keyboard",
          "is_correct": true,
          "display_order": 1,
          "explanation": "This success criterion ensures all functionality is available through keyboard."
        },
        {
          "content": "2.4.1 Bypass Blocks",
          "is_correct": false,
          "display_order": 2,
          "explanation": "This criterion is about bypassing repeated content."
        }
      ],
      "explanation": "WCAG 2.1.1 Keyboard requires all functionality to be available through keyboard interface.",
      "hints": ["Think about Level A requirements", "Consider keyboard-only users"]
    }
  ],
  "metadata": {
    "total_questions": 5,
    "generation_timestamp": "2026-01-23T19:30:00",
    "ai_model": "gpt-4o",
    "skill_id": "30000000-0000-0000-0000-000000000078",
    "skill_name": "Accessibility and inclusion",
    "language": "en"
  }
}

**Note**: Questions are now generated by Azure OpenAI (GPT-4o) with guaranteed skill_id in every question.
```

---

## Test in Browser

### Swagger UI
http://localhost:8002/api/docs

### ReDoc
http://localhost:8002/api/redoc

---

## Test with PowerShell

```powershell
# Health check
Invoke-RestMethod -Uri "http://localhost:8002/api/v2/health" -Method Get

# Get skills
Invoke-RestMethod -Uri "http://localhost:8002/api/v2/skills" -Method Get

# Generate questions
$body = @{
    question_type = @("Multiple Choice")
    language = "English"
    number_of_questions = 5
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:8002/api/v2/generate-questions" `
  -Method Post `
  -Body $body `
  -ContentType "application/json"
```

---

## Troubleshooting

### Port Already in Use
```bash
# Windows: Find and kill process on port 8002
netstat -ano | findstr :8002
taskkill /PID <PID> /F
```

### Import Error
```bash
# Make sure you're in the venv
.venv\Scripts\activate
```

### Database Connection Error
Check `ai-gen/src/custom.py` for correct connection string.

---

## Next Steps After Testing

1. ✅ Verify all endpoints work
2. ✅ Check database connection
3. ✅ Implement actual AI generation with Gemini 2.0
4. ⏳ Update C# backend to call this API
5. ⏳ Test full integration
